<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCS_view</title>
    <script type="application/javascript">
        class Point {
            constructor(name, x, y) {
                this.name = name;
                this.x = x;
                this.y = y;
            }
        }
        class Path {
            constructor(name, start, end) {
                this.name = name;
                this.start = start;
                this.end = end;
                this.locked = false;
            }
        }
        class Location {
            constructor(name, x, y, link) {
                this.name = name;
                this.x = x;
                this.y = y;
                this.link = link;
                this.locked = false;
            }
        }
        class Vehicle {
            constructor(name, x, y) {
                this.name = name;
                this.x = x;
                this.y = y;
                this.color = "#891111";
                this.step = [];
                this.destination = {};
            }
        }
        let points = [];
        let paths = [];
        let locations = [];
        let vehicles = []
        let xmin = 0;
        let xman = 400;
        let ymin = 0;
        let yman = 400;
        let resolution = 50;
        let is_running = false;
        let timer_draw_vehlice = setInterval(() => {
            clearInterval(timer_draw_vehlice);
        }, 500)
        function add_wheel(ctx) {
            let canvas = document.getElementById(ctx);
            canvas.addEventListener('wheel', function (event) {
                let deltaY = event.deltaY;
                if (is_running) {
                    event.preventDefault();
                    //放缩分辨率
                    if (deltaY > 0) {
                        resolution += 5;
                        document.getElementById("resolution").setAttribute('value', resolution);
                        clicked();

                    } else if (deltaY < 0) {
                        resolution -= 5;
                        document.getElementById("resolution").setAttribute('value', resolution);
                        clicked();
                    }
                }

            });
        }
        function get_img_limit() {
            let x_min = 9999999;
            let x_max = -9999999;
            let y_min = 9999999;
            let y_max = -9999999;
            for (let x of points) {
                if (x.x < x_min) {
                    x_min = x.x;
                }
                if (x.x > x_max) {
                    x_max = x.x;
                }
                if (x.y < y_min) {
                    y_min = x.y;
                }
                if (x.y > y_max) {
                    y_max = x.y;
                }
            }
            for (let x of locations) {
                if (x.x < x_min) {
                    x_min = x.x;
                }
                if (x.x > x_max) {
                    x_max = x.x;
                }
                if (x.y < y_min) {
                    y_min = x.y;
                }
                if (x.y > y_max) {
                    y_max = x.y;
                }
            }
            xmin = x_min - 5000;
            xman = x_max + 5000;
            ymin = y_min - 5000;
            yman = y_max + 5000;
        }
        function get_point(name) {
            for (let x of points) {
                if (x.name == name) {
                    return x;
                }
            }
            return null
        }
        function get_location(name) {
            for (let x of locations) {
                if (x.name == name) {
                    return x;
                }
            }
            return null
        }
        function get_model() {
            if (is_running) {
                is_running = false;
                clearInterval(timer_draw_vehlice);
                document.getElementById('stop_btn').style.display = 'none';
                document.getElementById('ok_btn').style.display = '';
            }
            let Http = new XMLHttpRequest();
            let res = document.getElementById('resolution');
            resolution = parseFloat(res.value);
            let ip = document.getElementById("ip_btn").value;
            let pattern = new RegExp("^((25[0-5]|2[0-4]\\d|1\\d{2}|[1-9]\\d|\\d)\\.){3}(25[0-5]|2[0-4]\\d|1\\d{2}|[1-9]\\d|\\d):([1-9]|[1-9]\\d{1,3}|[1-6][0-5][0-5][0-3][0-5])$")
            if (!pattern.test(ip)) {
                alert("请输入正确的ip格式-> ip:port")
                // console.log(ip)
                unconnect('map');
                unconnect('Vehicle');
                document.getElementById('ip_btn').value = "";
                return
            }
            Http.open('GET', 'http://' + ip + '/plantModel', true);
            // console.log('http://' + ip + '/plantModel')
            Http.withCredentials = true;
            Http.onload = function () {
                if (Http.readyState == 4 && Http.status == 200) {
                    points = [];
                    paths = [];
                    locations = []
                    let model = JSON.parse(Http.responseText);
                    // console.log(model);
                    for (let point of model["points"]) {
                        let x = point["layout"]["position"]["x"];
                        let y = point["layout"]["position"]["y"];
                        let name = point["name"];
                        let p = new Point(name, x, y);
                        points.push(p);
                    }
                    for (let path of model["paths"]) {
                        let end = path["destPointName"];
                        let start = path["srcPointName"]
                        let locked = path["locked"];
                        let name = path["name"];
                        let p = new Path(name, start, end);
                        p.locked = locked;
                        paths.push(p);
                    }
                    for (let loc of model["locations"]) {
                        let x = loc["layout"]["position"]["x"];
                        let y = loc["layout"]["position"]["y"];
                        let name = loc["name"];
                        let locked = loc["locked"];
                        let link = loc["links"][0];
                        let p = new Location(name, x, y, link);
                        p.locked = locked;
                        locations.push(p);
                    }
                    get_img_limit();
                    // console.log('-------------', model_has)
                    draw_map();
                    is_running = true
                    document.getElementById('stop_btn').style.display = '';
                    document.getElementById('ok_btn').style.display = 'none';
                    timer_draw_vehlice = setInterval(() => {
                        get_view();
                        draw_vehicle();
                    }, 300)
                }
                else {
                    console.log("get model failed");
                }
            }
            Http.onerror = function (e) {
                alert("请求失败,检查服务器地址和请求参数")
                unconnect('map');
                unconnect('Vehicle');
            }
            Http.onloadstart = function () {
                // console.log("start request")
            }
            Http.onloadend = function () {
                // console.log("request end")
            }
            Http.onabort = function () {
                console.log("request failed")
            }
            Http.send();
        }
        function get_view() {
            let res = document.getElementById('resolution');
            resolution = parseFloat(res.value);
            let Http = new XMLHttpRequest();
            let ip = document.getElementById("ip_btn").value;
            let pattern = new RegExp("^((25[0-5]|2[0-4]\\d|1\\d{2}|[1-9]\\d|\\d)\\.){3}(25[0-5]|2[0-4]\\d|1\\d{2}|[1-9]\\d|\\d):([1-9]|[1-9]\\d{1,3}|[1-6][0-5][0-5][0-3][0-5])$")
            let reg = new RegExp(pattern)
            if (!reg.test(ip)) {
                document.getElementById('ip_btn').value = "";
                return
            }
            Http.open('GET', 'http://' + ip + '/getView', true);
            Http.withCredentials = true;
            Http.onload = function () {
                if (Http.readyState == 4 && Http.status == 200) {
                    vehicles = [];
                    let model = JSON.parse(Http.responseText);
                    for (let v of model) {
                        // console.log(x = v["position"]);
                        let veh = new Vehicle(v["name"], v["position"]["x"], v["position"]["y"]);
                        veh.color = v["color"];
                        // console.log(v["step"]);
                        veh.step = v["step"];
                        veh.destination = v["destination"]
                        vehicles.push(veh);
                    }
                }
            }
            Http.onerror = function (e) {
                // console.log(e);
            }
            // Http.onloadstart = function () {
            //     console.log("start request")
            // }
            // Http.onloadend = function () {
            //     console.log("request end")
            // }
            // Http.onabort = function () {
            //     console.log("request failed")
            // }
            Http.send();
        }
        function drawArrowhead(ctx, x1, y1, x2, y2, size, color) {
            let l = 10 * (50 / resolution); // 
            let a = Math.atan2((y2 - y1), (x2 - x1));
            let x3 = x2 - l * Math.cos(a + 30 * Math.PI / 180); // θ=30
            let y3 = y2 - l * Math.sin(a + 30 * Math.PI / 180);
            let x4 = x2 - l * Math.cos(a - 30 * Math.PI / 180);
            let y4 = y2 - l * Math.sin(a - 30 * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.moveTo(x3, y3);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x4, y4);
            ctx.lineWidth = size;
            ctx.strokeStyle = color;
            ctx.stroke();
        }
        function start() {
            add_wheel('map')
            add_wheel('Vehicle')
            unconnect('map');
            unconnect('Vehicle');
            document.getElementById('stop_btn').style.display = 'none';
            document.getElementById('ok_btn').style.display = '';
        }
        function draw_map() {
            let canvas = document.getElementById("map");
            canvas.width = (xman - xmin) / resolution
            canvas.height = (yman - ymin) / resolution
            if (canvas.getContext) {
                let ctx = canvas.getContext("2d");
                // console.log(canvas.width + " " + canvas.height + " " + points.length)
                ctx.beginPath()
                ctx.fillStyle = "rgb(10,10,10)";
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                for (let point of points) {
                    let x = (point.x - xmin) / resolution;
                    let y = canvas.height - (point.y - ymin) / resolution;
                    let radius = 8 * (50 / resolution);
                    ctx.beginPath()
                    ctx.fillStyle = "rgb(0,0,0)";
                    ctx.strokeStyle = 'black'
                    ctx.moveTo(x + radius, y);
                    ctx.lineWidth = 3 * (50 / resolution);
                    if (ctx.lineWidth < 1) {
                        ctx.lineWidth = 1;
                    }
                    ctx.arc(x, y, radius, 0, 2 * Math.PI, true)
                    ctx.stroke()
                    let font_size = (13 * (50 / resolution)).toFixed(0);
                    if (font_size < 1) {
                        font_size = 1;
                    }
                    ctx.font = font_size.toString() + 'px Arial';
                    ctx.fillStyle = "black";
                    ctx.textBaseline = "top";
                    ctx.fillText(point.name, x + 10, y + 23, point.name.length * font_size);
                }
                for (let x of paths) {
                    if (x.locked) {
                        continue
                    }
                    let start = get_point(x.start);
                    let end = get_point(x.end);
                    // console.log(x["name"], start["name"], end["name"]);
                    let start_x = (start.x - xmin) / resolution;
                    let start_y = canvas.height - (start.y - ymin) / resolution;
                    let end_x = (end.x - xmin) / resolution;
                    let end_y = canvas.height - (end.y - ymin) / resolution;
                    // console.log(start_x, start_y, end_x, end_y);

                    let len = Math.sqrt((end_x - start_x) * (end_x - start_x) + (end_y - start_y) * (end_y - start_y))
                    // console.log(len);
                    let norm_x = (end_x - start_x) / len;
                    let norm_y = (end_y - start_y) / len;
                    start_x = start_x + norm_x * 15;
                    start_y = start_y + norm_y * 15;
                    end_x = end_x - norm_x * 15;
                    end_y = end_y - norm_y * 15;
                    drawArrowhead(ctx, start_x, start_y, end_x, end_y, 1 * (50 / resolution), 'orange');
                    drawArrowhead(ctx, end_x, end_y, start_x, start_y, 1 * (50 / resolution), 'orange');
                }
                for (let loc of locations) {
                    if (loc.locked) {
                        continue
                    }
                    let start_x = (loc.x - xmin) / resolution;
                    let start_y = canvas.height - (loc.y - ymin) / resolution;
                    let link = get_point(loc.link);
                    let link_x = (link.x - xmin) / resolution;
                    let link_y = canvas.height - (link.y - ymin) / resolution;
                    ctx.beginPath()
                    ctx.lineWidth = 1 * (50 / resolution);
                    if (ctx.lineWidth < 1) {
                        ctx.lineWidth = 1;
                    }
                    let radius = 5 * (50 / resolution)
                    ctx.strokeStyle = '#233bc2'
                    ctx.moveTo(start_x + radius, start_y);
                    ctx.arc(start_x, start_y, radius, 0, 2 * Math.PI, true)
                    ctx.stroke()
                    ctx.strokeRect(start_x - 25 * (50 / resolution), start_y - 15 * (50 / resolution), 50 * (50 / resolution), 30 * (50 / resolution));
                    let len = Math.sqrt((link_x - start_x) * (link_x - start_x) + (link_y - start_y) * (link_y - start_y));
                    let norm_x = (link_x - start_x) / len;
                    let norm_y = (link_y - start_y) / len;
                    start_x = start_x + norm_x * 10 * (50 / resolution);
                    start_y = start_y + norm_y * 10 * (50 / resolution);
                    link_x = link_x - norm_x * 10 * (50 / resolution);
                    link_y = link_y - norm_y * 10 * (50 / resolution);
                    ctx.beginPath()
                    ctx.strokeStyle = '#909090'
                    ctx.moveTo(start_x, start_y);
                    ctx.lineTo(link_x, link_y)
                    ctx.stroke()
                    let font_size = (13 * (50 / resolution)).toFixed(0);
                    ctx.font = font_size.toString() + 'px Arial';
                    ctx.fillStyle = "black";
                    ctx.textBaseline = "top";
                    ctx.fillText(loc.name, start_x - 35, start_y - 43, loc.name.length * font_size);
                }
            }
        }

        function unconnect(ctx) {
            let canvas = document.getElementById(ctx);
            canvas.width = 400
            canvas.height = 400
            if (canvas.getContext) {
                let context = canvas.getContext("2d");
                context.font = '40px Arial';
                context.fillStyle = '#04AA6D';
                context.textBaseline = 'top';
                context.fillText("未连接", 150, 200, 200);
            }
        }

        function draw_vehicle() {
            let canvas = document.getElementById("Vehicle");
            canvas.width = (xman - xmin) / resolution
            canvas.height = (yman - ymin) / resolution
            if (canvas.getContext) {
                let ctx = canvas.getContext("2d");

                // console.log(canvas.width, canvas.height)
                for (let v of vehicles) {
                    // console.log(v);
                    let x = (v.x - xmin) / resolution;
                    let y = canvas.height - (v.y - ymin) / resolution;
                    ctx.beginPath()
                    ctx.fillStyle = v.color;
                    ctx.strokeStyle = v.color
                    let font_size = (20 * (50 / resolution)).toFixed(0);
                    if (font_size < 1) {
                        font_size = 1;
                    }
                    ctx.font = font_size.toString() + 'px Arial';
                    ctx.textBaseline = "top";
                    ctx.fillText(v.name, x, y, v.name.length * font_size);
                    for (let step of v.step) {
                        let start = get_point(step["src"]);
                        let end = get_point(step["dest"]);
                        let ori = step["orientation"];
                        let start_x = (start.x - xmin) / resolution;
                        let start_y = canvas.height - (start.y - ymin) / resolution;
                        let end_x = (end.x - xmin) / resolution;
                        let end_y = canvas.height - (end.y - ymin) / resolution;
                        let len = Math.sqrt((end_x - start_x) * (end_x - start_x) + (end_y - start_y) * (end_y - start_y))
                        // console.log(len);
                        let norm_x = (end_x - start_x) / len;
                        let norm_y = (end_y - start_y) / len;
                        start_x = start_x + norm_x * 15;
                        start_y = start_y + norm_y * 15;
                        end_x = end_x - norm_x * 15;
                        end_y = end_y - norm_y * 15;
                        if (ori == "FORWARD") { drawArrowhead(ctx, start_x, start_y, end_x, end_y, 5 * (50 / resolution), v.color); }
                        else if (ori == "BACKWARD") { drawArrowhead(ctx, end_x, end_y, start_x, start_y, 5 * (50 / resolution), v.color); }
                    }
                    // console.log(v.destination);
                    if (v.destination != undefined) {
                        let loc = get_location(v.destination["dest"]);
                        let start_x = (loc.x - xmin) / resolution;
                        let start_y = canvas.height - (loc.y - ymin) / resolution;
                        let link = get_point(loc.link);
                        let link_x = (link.x - xmin) / resolution;
                        let link_y = canvas.height - (link.y - ymin) / resolution;
                        ctx.beginPath()
                        ctx.lineWidth = 4 * (50 / resolution);
                        if (ctx.lineWidth < 1) {
                            ctx.lineWidth = 1;
                        }
                        ctx.strokeStyle = '#ff0000'
                        ctx.moveTo(start_x + 5, start_y);
                        ctx.arc(start_x, start_y, 5, 0, 2 * Math.PI, true)
                        ctx.stroke()
                        ctx.strokeRect(start_x - 25 * (50 / resolution), start_y - 15 * (50 / resolution), 50 * (50 / resolution), 30 * (50 / resolution));
                        let len = Math.sqrt((link_x - start_x) * (link_x - start_x) + (link_y - start_y) * (link_y - start_y));
                        let norm_x = (link_x - start_x) / len;
                        let norm_y = (link_y - start_y) / len;
                        start_x = start_x + norm_x * 10 * (50 / resolution);
                        start_y = start_y + norm_y * 10 * (50 / resolution);
                        link_x = link_x - norm_x * 10 * (50 / resolution);
                        link_y = link_y - norm_y * 10 * (50 / resolution);
                        ctx.beginPath()
                        ctx.strokeStyle = '#909090'
                        ctx.moveTo(start_x, start_y);
                        ctx.lineTo(link_x, link_y)
                        ctx.stroke()
                    }
                }
            }
        }
        function clicked() {
            get_model();
        }
        function stop_() {
            if (is_running) {
                is_running = false
                clearInterval(timer_draw_vehlice);
                document.getElementById('stop_btn').style.display = 'none';
                document.getElementById('ok_btn').style.display = '';
            }
        }
    </script>
</head>


<body onload="start()">
    <div class="main">
        <div class="ip">
            <input type="text" id="ip_btn" class="label" value="127.0.0.1:8080" placeholder="服务器地址：端口号">
            <h1></h1>
        </div>
        <div class="resolution">
            <input type="number" id="resolution" class="label" value="50" placeholder="显示分辨率(mm/px)">
            <h1></h1>
        </div>
        <div>
            <button class="button" id="ok_btn" onclick="clicked()">确定</button>
            <button class="button" id="stop_btn" onclick="stop_()">停止</button>
        </div>
        <div class="view">
            <canvas id="map" width="400" height="400">
            </canvas>
            <canvas id="Vehicle" width="400" height="400">
            </canvas>
        </div>
    </div>
</body>
<style type="text/css">
    body {
        background: #ffffff;
    }

    div {
        position: relative;
        padding: 7px;
        text-align: center;
    }

    .label {
        padding: 10px;
        color: #2c80e7;
        font-size: 20px;
        border-top: none;
        border-left: none;
        border-right: none;
        border-bottom-width: 5px;
        border-bottom-color: #58a689;
        outline: none;
        /* background-color: #58a689; */
        /* background-color: #b4e3c6; */
    }


    .label::placeholder {
        color: rgb(86, 132, 151);
    }

    .button {
        background-color: #58a689;
        border: none;
        color: white;
        padding: 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 20px;
    }

    .button:hover {
        background-color: #e40f00;
    }

    .button:disabled {
        background-color: gray;
    }


    #map {
        position: absolute;
        left: 0px;
        top: 0px;
        margin: 20px;
        background: #ffffff;
        border: thin solid #1b7cdd;
    }

    #Vehicle {
        position: absolute;
        left: 0px;
        top: 0px;
        margin: 20px;
        border: thin solid #1b7cdd;
    }
</style>

</html>