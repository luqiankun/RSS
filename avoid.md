#### 派遣器订单结构

```c++
/*
       index
         |
        \|/                    #
     +-------+     +-------+   #    +-------+
     | ord4  |     | ord3  |   #    | ord4  |
     +-------+     +-------+   #    +-------+
     | ord2  |     | ord1  |   #    | ord8  |
     +-------+     +-------+   #    +-------+
     vehicle-1     vehicle-2   #     random

*/
```

1. **订单排序,派发顺序**

- 优先级高的优先，顶部为该车辆当前处理的的订单或下个待处理订单
- 优先级相同时避让订单优先，先执行避让订单，再执行普通订单
- 避让订单只保留最新的（避让完当前车辆后，上一个冲突可能已经消失）
- 普通订单创建时间早优先，先执行最早加入的订单
- 截止时间(TO-DO)

2. **新订单加入**

- 指定了执行车辆，加入到对应车辆的队列，没有队列则创建
- 未指定车辆，加入随机队列

3. **重新派发的订单**

- 避让订单，丢弃
- 普通订单
  - 已经完成一个运输订单了，无法更换车辆了，加入到订单指派的车辆的队列中
  - 第一个运输订单还没执行完，且下订单时候没有指定车辆，可以重新派别的车辆执行，加入到随机订单队列

4. **订单处理**

- 至少有一个车辆IDLE并且随机订单队列不为空，从随机队列取取一个订单
- 如果不存在IDLE车辆或随机订单，取当前索引车辆的队顶订单，index+1，到最大后index=0，循环选择
- 订单为空休眠，否则判断有无指定车辆，没有则选择最优车辆，加入到对应车辆的订单队列
- 规划路径，判断订单是否可达，不可达订单置为失败状态
- 执行一次冲突状态判断和解决（冲突状态机）
- 如果冲突未解决，返回，等待下次处理
- 冲突解决了，如果车辆IDLE且没有等待避让其他车辆，则派发到车辆执行，否则继续等待

5. 资源死锁检测

  要申请的资源互相在对方车辆中，发生死锁，两个车辆的订单重新派发

#### 冲突解决策略

- 冲突定义

  - 规划的路径上存在IDLE车辆，**阻挡冲突**
  - 规划的路径和在执行状态的其他车辆有重合路段且方向相反，**交换冲突**
  - 虽然同向但是目标点在执行状态的其他车辆的路径中，**包含冲突**
- 冲突解决

  ```c++

  /*

   +---------+                             +-----------+----------+
   |vehicle-1|                             | vehicle-1 | point-3  |
   +---------+                             +-----------+----------+
   |vehicle-3|                             | vehicle-3 | point-1  |
   +---------+                             +-----------+----------+
     待解决队列                                   已解决队列


  */

  ```

  - 派单前

    1. 沿自身车辆要走的路径收集所有阻挡冲突（IDLE）车辆加入到**待解决队列**
    2. 为每个车辆选择一个避让点（下方具体规则），出**待解决队列**，加入到**已解决队列**
    3. 检查这些车辆到避让点之间有无新的阻挡冲突，有就加入到**待解决队列**
    4. 重复2—3 直到**待解决队列**为空
       - 如果过程中发现新的冲突车辆是自身车辆（必须自己先移动开，否则无解），则清空两个队列，为自身选择一个避让点，发单，并重置冲突状态，结束流程
    5. 检查**已解决队列里**的车辆之间有无包含冲突，有则交换避让点
    6. 取已解决队列顶项，检查该避让路径是否和其他车辆有交换冲突或包含冲突，如果有就**`<u>`等待 `</u>`**冲突消失（冲突车辆IDLE了或走开了），没有冲突了就新建订单发给派遣器
    7. 所有冲突车辆都发单结束后，检查自身车辆的路径是否和其他车辆有交换冲突，如果有就**`<u>`等待 `</u>`**，没有冲突了则冲突解决完成，流程结束
  - 执行中

    执行中其他车辆可能变为新的冲突

    - 每个step申请资源前检查和其他车辆是否有阻挡冲突、交换冲突
    - 如果有冲突则重新派发订单，回到派发前状态，再执行一轮冲突解决

#### 避让点选择策略

```C++
/*
	两个优先队列

	+-----------+        +-----------+   
	| point-1   |        | point-3   |
	+-----------+        +-----------+
	| point-2   |        | point-4   |
	+-----------+        +-----------+
	 巷道避让点               普通路点 

*/
```

##### 巷道优先队列评价函数

$$
F(P)=\tfrac{1}{P_{occ}+10^{-4}+P_{dist}}
$$

$$
P_{occ}=\begin{cases} \tfrac{N_{i}}{N_{a}},p在巷道内(N_i 巷道内空闲的点个数，N_a巷道点总个数)\\[2ex]
1，p不在巷道内\end{cases}
$$


$$
P_{dist}=\tfrac{2}{1+e^{-kx}}-1 , x 该点距离起点的路径长度，单位m，k比例系数
$$

1. 选出所有空闲点

   - 没有被锁定的点
   - ~~有被锁定但是该车辆是空闲状态~~
2. 排除一些不可选的点

   - 排除占用率高的巷道点
   - 如果车辆是出巷道，巷道内深度大于当前点的其他点
   - 排除车辆路径上的点
   - 排除已解决队列里已经被选择的点
   - 排除待躲避车辆当前所在的点
3. 计算得分加入队列
4. 优先队列不为空，则取队列顶值
5. 队列为空，则无可选点
